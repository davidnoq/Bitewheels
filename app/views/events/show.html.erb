<!-- app/views/events/show.html.erb -->

<%# Display Flash Messages %>
<% if flash[:notice] %>
  <div class="alert alert-success alert-dismissible fade show" role="alert">
    <%= flash[:notice] %>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>
<% elsif flash[:alert] %>
  <div class="alert alert-danger alert-dismissible fade show" role="alert">
    <%= flash[:alert] %>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>
<% end %>

<%# Set the Page Title %>
<% content_for :title, @event.name %>

<div class="d-flex justify-content-center align-items-center m-auto min-vh-100 bg-white">
  <div class="container">
    <div class="card shadow-lg" style="max-width: 40rem; margin: auto; min-height: 400px;">
      <div class="card-header bg-dark text-white text-center">
        <h1 class="mb-0"><%= @event.name %></h1>
      </div>
      <div class="card-body" style="min-height: 300px;">
        <!-- Event Details -->
        <%= render @event, 
                  show_date: true, 
                  show_name: false, 
                  show_latitude_longitude: true, 
                  show_map: false, 
                  show_expected_attendees: true, 
                  show_address: true, 
                  show_end_date: true %>

        <!-- Credit Cost Display (Visible Only to Non-Event Organizers) -->
        <% unless current_user&.eventorganizer? %>
  <p class="card-text">
    <strong>Credit Cost to Apply:</strong> <%= @event.credit_cost %>
  </p>
<% end %>

<% if current_user.nil? %>
  <!-- Show Apply button for unauthenticated users -->
  <%= link_to "Apply to Event", apply_to_event_path(event_id: @event.id), class: "btn btn-primary" %>
<% elsif current_user.foodtruckowner? %>
  <!-- Show Apply button for food truck owners -->
  <%= link_to "Apply to Event", new_event_event_application_path(event_id: @event.id), class: "btn btn-primary" %>
<% elsif !current_user.eventorganizer? %>
  <!-- Show Apply button for signed-in non-event-organizers who are not food truck owners -->
  <%= link_to "Apply to Event", apply_to_event_path(event_id: @event.id), class: "btn btn-primary" %>
<% end %>



        <!-- Approved Food Trucks Section -->
        <h3 class="mt-4"><%= @event.completed? ? "Food Trucks Attended" : "Food Trucks Attending" %></h3>
        <% if @approved_food_trucks.any? %>
          <ul class="list-group mb-3">
            <% @approved_food_trucks.each do |food_truck| %>
              <li class="list-group-item">
                <strong><%= food_truck.name %></strong> - <%= food_truck.cuisine %>
              </li>
            <% end %>
          </ul>
        <% else %>
          <p class="text-muted"><%= @event.completed? ? "No food trucks attended this event." : "No food trucks are currently attending this event." %></p>
        <% end %>

        <% if @event.published? %>
          <!-- Published Event Controls -->
          <% if current_user&.eventorganizer? && current_user == @event.user %>
            <div class="d-flex justify-content-between mb-3">
              <%= link_to "Edit Event", edit_event_path(@event), class: "btn btn-primary" %>
              <%= link_to "Manage Applications", event_event_applications_path(@event), class: "btn btn-primary" %>
              <%= button_to "Mark as Completed", complete_event_path(@event), method: :patch, data: { confirm: "Are you sure you want to mark this event as completed?" }, class: "btn btn-success" %>
              <%= button_to "Delete Event", @event, method: :delete, data: { confirm: "Are you sure you want to delete this event?" }, class: "btn btn-danger" %>
            </div>
          <% end %>

          

        <% elsif @event.draft? %>
          <!-- Draft Event Controls -->
          <p class="text-muted">This event is still a draft. Applications will be available once the event is published.</p>
          <% if current_user&.eventorganizer? && current_user == @event.user %>
            <div class="d-flex justify-content-between mb-3">
              <%= link_to "Edit Event", edit_event_path(@event), class: "btn btn-primary" %>
              <%= button_to "Publish Event", publish_event_path(@event), method: :patch, data: { confirm: "Are you sure you want to publish this event?" }, class: "btn btn-success" %>
              <%= button_to "Delete Event", @event, method: :delete, data: { confirm: "Are you sure you want to delete this event?" }, class: "btn btn-danger" %>
            </div>
          <% end %>

        <% elsif @event.completed? %>
          <!-- Completed Event Controls -->
          <p class="text-muted">Rate past food trucks on their performance.</p>
          <% if current_user&.eventorganizer? && current_user == @event.user %>
            <div class="d-flex justify-content-cetner mb-3">
              <%= link_to "Visit Food Trucks", event_event_applications_path(@event), class: "btn btn-primary" %>
            </div>
          <% end %>
        <% end %>

      </div>
    </div>
  </div>
</div>
